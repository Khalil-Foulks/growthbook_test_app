{"version":3,"file":"GrowthBook.js","names":["mutate","getUrlRegExp","isIncluded","getBucketRanges","hash","chooseVariation","getQueryStringOverride","inNamespace","inRange","isURLTargeted","decrypt","evalCondition","refreshFeatures","subscribe","unsubscribe","isBrowser","window","document","GrowthBook","constructor","context","_ctx","_renderer","_trackedExperiments","Set","_trackedFeatures","debug","_subscriptions","_rtQueue","_rtTimer","ready","_assigned","Map","_forcedFeatureValues","_attributeOverrides","_activeAutoExperiments","features","enableDevMode","_growthbook","dispatchEvent","Event","experiments","_updateAllAutoExperiments","clientKey","_refresh","loadFeatures","options","autoRefresh","getApiInfo","apiHost","replace","allowStale","updateInstance","Error","timeout","skipCache","_render","setFeatures","setEncryptedFeatures","encryptedString","decryptionKey","subtle","featuresJSON","JSON","parse","setExperiments","setEncryptedExperiments","experimentsJSON","setAttributes","attributes","setAttributeOverrides","overrides","setForcedVariations","vars","forcedVariations","setForcedFeatures","map","setURL","url","getAttributes","getFeatures","getExperiments","cb","add","delete","getAllResults","destroy","clear","clearTimeout","forEach","exp","undo","setRenderer","renderer","forceVariation","key","variation","run","experiment","result","_run","_fireSubscriptions","triggerExperiment","find","manual","_runAutoExperiment","forceManual","forceRerun","existing","get","valueHash","stringify","value","inExperiment","_undoActiveAutoExperiment","_applyDOMChanges","set","keys","e","v","k","has","prev","variationId","console","error","_trackFeatureUsage","res","source","stringifiedValue","onFeatureUsage","fetch","push","on","setTimeout","q","realtimeKey","encodeURIComponent","cache","mode","catch","realtimeInterval","_getFeatureResult","ruleId","ret","off","experimentResult","isOn","evalFeature","isOff","getFeatureValue","defaultValue","feature","id","process","env","NODE_ENV","log","rules","rule","condition","_conditionPasses","filters","_isFilteredOut","_isIncludedInRollout","seed","hashAttribute","range","coverage","hashVersion","tracks","t","_track","force","variations","weights","namespace","meta","ranges","name","phase","passthrough","undefined","hashValue","_getHashAttribute","n","some","filter","attribute","r","featureId","numVariations","length","_getResult","enabled","_mergeOverrides","qsOverride","_getContextUrl","status","active","include","groups","_hasGroupOverlap","_urlIsValid","urlPatterns","assigned","qaMode","msg","ctx","trackingCallback","o","Object","assign","attr","user","variationIndex","hashUsed","bucket","location","href","urlRegex","pathOnly","test","expGroups","i","changes","css","s","createElement","innerHTML","head","appendChild","remove","js","script","body","domMutations","mutation","declarative","revert","fn"],"sources":["../../src/GrowthBook.ts"],"sourcesContent":["import mutate, { DeclarativeMutation } from \"dom-mutator\";\nimport type {\n  Context,\n  Experiment,\n  FeatureResult,\n  Result,\n  SubscriptionFunction,\n  FeatureDefinition,\n  FeatureResultSource,\n  Attributes,\n  WidenPrimitives,\n  RealtimeUsageData,\n  LoadFeaturesOptions,\n  RefreshFeaturesOptions,\n  ApiHost,\n  ClientKey,\n  VariationMeta,\n  Filter,\n  VariationRange,\n  AutoExperimentVariation,\n  AutoExperiment,\n} from \"./types/growthbook\";\nimport type { ConditionInterface } from \"./types/mongrule\";\nimport {\n  getUrlRegExp,\n  isIncluded,\n  getBucketRanges,\n  hash,\n  chooseVariation,\n  getQueryStringOverride,\n  inNamespace,\n  inRange,\n  isURLTargeted,\n  decrypt,\n} from \"./util\";\nimport { evalCondition } from \"./mongrule\";\nimport { refreshFeatures, subscribe, unsubscribe } from \"./feature-repository\";\n\nconst isBrowser =\n  typeof window !== \"undefined\" && typeof document !== \"undefined\";\n\nexport class GrowthBook<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  AppFeatures extends Record<string, any> = Record<string, any>\n> {\n  // context is technically private, but some tools depend on it so we can't mangle the name\n  // _ctx below is a clone of this property that we use internally\n  private context: Context;\n  public debug: boolean;\n  public ready: boolean;\n\n  // Properties and methods that start with \"_\" are mangled by Terser (saves ~150 bytes)\n  private _ctx: Context;\n  private _renderer: null | (() => void);\n  private _trackedExperiments: Set<unknown>;\n  private _trackedFeatures: Record<string, string>;\n  private _subscriptions: Set<SubscriptionFunction>;\n  private _rtQueue: RealtimeUsageData[];\n  private _rtTimer: number;\n  private _assigned: Map<\n    string,\n    {\n      // eslint-disable-next-line\n      experiment: Experiment<any>;\n      // eslint-disable-next-line\n      result: Result<any>;\n    }\n  >;\n  // eslint-disable-next-line\n  private _forcedFeatureValues: Map<string, any>;\n  private _attributeOverrides: Attributes;\n  private _activeAutoExperiments: Map<\n    string,\n    { valueHash: string; undo: () => void }\n  >;\n\n  constructor(context?: Context) {\n    context = context || {};\n    // These properties are all initialized in the constructor instead of above\n    // This saves ~80 bytes in the final output\n    this._ctx = this.context = context;\n    this._renderer = null;\n    this._trackedExperiments = new Set();\n    this._trackedFeatures = {};\n    this.debug = false;\n    this._subscriptions = new Set();\n    this._rtQueue = [];\n    this._rtTimer = 0;\n    this.ready = false;\n    this._assigned = new Map();\n    this._forcedFeatureValues = new Map();\n    this._attributeOverrides = {};\n    this._activeAutoExperiments = new Map();\n\n    if (context.features) {\n      this.ready = true;\n    }\n\n    if (isBrowser && context.enableDevMode) {\n      window._growthbook = this;\n      document.dispatchEvent(new Event(\"gbloaded\"));\n    }\n\n    if (context.experiments) {\n      this.ready = true;\n      this._updateAllAutoExperiments();\n    }\n\n    if (context.clientKey) {\n      this._refresh({}, true, false);\n    }\n  }\n\n  public async loadFeatures(options?: LoadFeaturesOptions): Promise<void> {\n    await this._refresh(options, true, true);\n    if (options && options.autoRefresh) {\n      subscribe(this);\n    }\n  }\n\n  public async refreshFeatures(\n    options?: RefreshFeaturesOptions\n  ): Promise<void> {\n    await this._refresh(options, false, true);\n  }\n\n  public getApiInfo(): [ApiHost, ClientKey] {\n    return [\n      (this._ctx.apiHost || \"https://cdn.growthbook.io\").replace(/\\/*$/, \"\"),\n      this._ctx.clientKey || \"\",\n    ];\n  }\n\n  private async _refresh(\n    options?: RefreshFeaturesOptions,\n    allowStale?: boolean,\n    updateInstance?: boolean\n  ) {\n    options = options || {};\n    if (!this._ctx.clientKey) {\n      throw new Error(\"Missing clientKey\");\n    }\n    await refreshFeatures(\n      this,\n      options.timeout,\n      options.skipCache || this._ctx.enableDevMode,\n      allowStale,\n      updateInstance\n    );\n  }\n\n  private _render() {\n    if (this._renderer) {\n      this._renderer();\n    }\n  }\n\n  public setFeatures(features: Record<string, FeatureDefinition>) {\n    this._ctx.features = features;\n    this.ready = true;\n    this._render();\n  }\n\n  public async setEncryptedFeatures(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<void> {\n    const featuresJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._ctx.decryptionKey,\n      subtle\n    );\n    this.setFeatures(\n      JSON.parse(featuresJSON) as Record<string, FeatureDefinition>\n    );\n  }\n\n  public setExperiments(experiments: AutoExperiment[]): void {\n    this._ctx.experiments = experiments;\n    this.ready = true;\n    this._updateAllAutoExperiments();\n  }\n\n  public async setEncryptedExperiments(\n    encryptedString: string,\n    decryptionKey?: string,\n    subtle?: SubtleCrypto\n  ): Promise<void> {\n    const experimentsJSON = await decrypt(\n      encryptedString,\n      decryptionKey || this._ctx.decryptionKey,\n      subtle\n    );\n    this.setExperiments(JSON.parse(experimentsJSON) as AutoExperiment[]);\n  }\n\n  public setAttributes(attributes: Attributes) {\n    this._ctx.attributes = attributes;\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n\n  public setAttributeOverrides(overrides: Attributes) {\n    this._attributeOverrides = overrides;\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n  public setForcedVariations(vars: Record<string, number>) {\n    this._ctx.forcedVariations = vars || {};\n    this._render();\n    this._updateAllAutoExperiments();\n  }\n  // eslint-disable-next-line\n  public setForcedFeatures(map: Map<string, any>) {\n    this._forcedFeatureValues = map;\n    this._render();\n  }\n\n  public setURL(url: string) {\n    this._ctx.url = url;\n    this._updateAllAutoExperiments(true);\n  }\n\n  public getAttributes() {\n    return { ...this._ctx.attributes, ...this._attributeOverrides };\n  }\n\n  public getFeatures() {\n    return this._ctx.features || {};\n  }\n\n  public getExperiments() {\n    return this._ctx.experiments || [];\n  }\n\n  public subscribe(cb: SubscriptionFunction): () => void {\n    this._subscriptions.add(cb);\n\n    return () => {\n      this._subscriptions.delete(cb);\n    };\n  }\n\n  public getAllResults() {\n    return new Map(this._assigned);\n  }\n\n  public destroy() {\n    // Release references to save memory\n    this._subscriptions.clear();\n    this._assigned.clear();\n    this._trackedExperiments.clear();\n    this._trackedFeatures = {};\n    this._rtQueue = [];\n    if (this._rtTimer) {\n      clearTimeout(this._rtTimer);\n    }\n    unsubscribe(this);\n\n    if (isBrowser && window._growthbook === this) {\n      delete window._growthbook;\n    }\n\n    // Undo any active auto experiments\n    this._activeAutoExperiments.forEach((exp) => {\n      exp.undo();\n    });\n    this._activeAutoExperiments.clear();\n  }\n\n  public setRenderer(renderer: () => void) {\n    this._renderer = renderer;\n  }\n\n  public forceVariation(key: string, variation: number) {\n    this._ctx.forcedVariations = this._ctx.forcedVariations || {};\n    this._ctx.forcedVariations[key] = variation;\n    this._render();\n  }\n\n  public run<T>(experiment: Experiment<T>): Result<T> {\n    const result = this._run(experiment, null);\n    this._fireSubscriptions(experiment, result);\n    return result;\n  }\n\n  public triggerExperiment(key: string) {\n    if (!this._ctx.experiments) return null;\n    const exp = this._ctx.experiments.find((exp) => exp.key === key);\n    if (!exp || !exp.manual) return null;\n    return this._runAutoExperiment(exp, true);\n  }\n\n  private _runAutoExperiment(\n    experiment: AutoExperiment,\n    forceManual?: boolean,\n    forceRerun?: boolean\n  ) {\n    const key = experiment.key;\n    const existing = this._activeAutoExperiments.get(key);\n\n    // If this is a manual experiment and it's not already running, skip\n    if (experiment.manual && !forceManual && !existing) return null;\n\n    // Run the experiment\n    const result = this.run(experiment);\n\n    // A hash to quickly tell if the assigned value changed\n    const valueHash = JSON.stringify(result.value);\n\n    // If the changes are already active, no need to re-apply them\n    if (\n      !forceRerun &&\n      result.inExperiment &&\n      existing &&\n      existing.valueHash === valueHash\n    ) {\n      return result;\n    }\n\n    // Undo any existing changes\n    if (existing) this._undoActiveAutoExperiment(key);\n\n    // Apply new changes\n    if (result.inExperiment) {\n      const undo = this._applyDOMChanges(result.value);\n      if (undo) {\n        this._activeAutoExperiments.set(experiment.key, {\n          undo,\n          valueHash,\n        });\n      }\n    }\n\n    return result;\n  }\n\n  private _undoActiveAutoExperiment(key: string) {\n    const exp = this._activeAutoExperiments.get(key);\n    if (exp) {\n      exp.undo();\n      this._activeAutoExperiments.delete(key);\n    }\n  }\n\n  private _updateAllAutoExperiments(forceRerun?: boolean) {\n    const experiments = this._ctx.experiments || [];\n\n    // Stop any experiments that are no longer defined\n    const keys = new Set(experiments.map((e) => e.key));\n    this._activeAutoExperiments.forEach((v, k) => {\n      if (!keys.has(k)) {\n        v.undo();\n        this._activeAutoExperiments.delete(k);\n      }\n    });\n\n    // Re-run all new/updated experiments\n    experiments.forEach((exp) => {\n      this._runAutoExperiment(exp, false, forceRerun);\n    });\n  }\n\n  private _fireSubscriptions<T>(experiment: Experiment<T>, result: Result<T>) {\n    const key = experiment.key;\n\n    // If assigned variation has changed, fire subscriptions\n    const prev = this._assigned.get(key);\n    // TODO: what if the experiment definition has changed?\n    if (\n      !prev ||\n      prev.result.inExperiment !== result.inExperiment ||\n      prev.result.variationId !== result.variationId\n    ) {\n      this._assigned.set(key, { experiment, result });\n      this._subscriptions.forEach((cb) => {\n        try {\n          cb(experiment, result);\n        } catch (e) {\n          console.error(e);\n        }\n      });\n    }\n  }\n\n  private _trackFeatureUsage(key: string, res: FeatureResult): void {\n    // Don't track feature usage that was forced via an override\n    if (res.source === \"override\") return;\n\n    // Only track a feature once, unless the assigned value changed\n    const stringifiedValue = JSON.stringify(res.value);\n    if (this._trackedFeatures[key] === stringifiedValue) return;\n    this._trackedFeatures[key] = stringifiedValue;\n\n    // Fire user-supplied callback\n    if (this._ctx.onFeatureUsage) {\n      try {\n        this._ctx.onFeatureUsage(key, res);\n      } catch (e) {\n        // Ignore feature usage callback errors\n      }\n    }\n\n    // In browser environments, queue up feature usage to be tracked in batches\n    if (!isBrowser || !window.fetch) return;\n    this._rtQueue.push({\n      key,\n      on: res.on,\n    });\n    if (!this._rtTimer) {\n      this._rtTimer = window.setTimeout(() => {\n        // Reset the queue\n        this._rtTimer = 0;\n        const q = [...this._rtQueue];\n        this._rtQueue = [];\n\n        // Skip logging if a real-time usage key is not configured\n        if (!this._ctx.realtimeKey) return;\n\n        window\n          .fetch(\n            `https://rt.growthbook.io/?key=${\n              this._ctx.realtimeKey\n            }&events=${encodeURIComponent(JSON.stringify(q))}`,\n\n            {\n              cache: \"no-cache\",\n              mode: \"no-cors\",\n            }\n          )\n          .catch(() => {\n            // TODO: retry in case of network errors?\n          });\n      }, this._ctx.realtimeInterval || 2000);\n    }\n  }\n\n  private _getFeatureResult<T>(\n    key: string,\n    value: T,\n    source: FeatureResultSource,\n    ruleId?: string,\n    experiment?: Experiment<T>,\n    result?: Result<T>\n  ): FeatureResult<T> {\n    const ret: FeatureResult = {\n      value,\n      on: !!value,\n      off: !value,\n      source,\n      ruleId: ruleId || \"\",\n    };\n    if (experiment) ret.experiment = experiment;\n    if (result) ret.experimentResult = result;\n\n    // Track the usage of this feature in real-time\n    this._trackFeatureUsage(key, ret);\n\n    return ret;\n  }\n\n  public isOn<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).on;\n  }\n\n  public isOff<K extends string & keyof AppFeatures = string>(key: K): boolean {\n    return this.evalFeature(key).off;\n  }\n\n  public getFeatureValue<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(key: K, defaultValue: V): WidenPrimitives<V> {\n    const value = this.evalFeature<WidenPrimitives<V>, K>(key).value;\n    return value === null ? (defaultValue as WidenPrimitives<V>) : value;\n  }\n\n  /**\n   * @deprecated Use {@link evalFeature}\n   * @param id\n   */\n  // eslint-disable-next-line\n  public feature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K): FeatureResult<V | null> {\n    return this.evalFeature(id);\n  }\n\n  public evalFeature<\n    V extends AppFeatures[K],\n    K extends string & keyof AppFeatures = string\n  >(id: K): FeatureResult<V | null> {\n    // Global override\n    if (this._forcedFeatureValues.has(id)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Global override\", {\n          id,\n          value: this._forcedFeatureValues.get(id),\n        });\n      return this._getFeatureResult(\n        id,\n        this._forcedFeatureValues.get(id),\n        \"override\"\n      );\n    }\n\n    // Unknown feature id\n    if (!this._ctx.features || !this._ctx.features[id]) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Unknown feature\", { id });\n      return this._getFeatureResult(id, null, \"unknownFeature\");\n    }\n\n    // Get the feature\n    const feature: FeatureDefinition<V> = this._ctx.features[id];\n\n    // Loop through the rules\n    if (feature.rules) {\n      for (const rule of feature.rules) {\n        // If it's a conditional rule, skip if the condition doesn't pass\n        if (rule.condition && !this._conditionPasses(rule.condition)) {\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Skip rule because of condition\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n        // If there are filters for who is included (e.g. namespaces)\n        if (rule.filters && this._isFilteredOut(rule.filters)) {\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Skip rule because of filters\", {\n              id,\n              rule,\n            });\n          continue;\n        }\n\n        // Feature value is being forced\n        if (\"force\" in rule) {\n          // If this is a percentage rollout, skip if not included\n          if (\n            !this._isIncludedInRollout(\n              rule.seed || id,\n              rule.hashAttribute,\n              rule.range,\n              rule.coverage,\n              rule.hashVersion\n            )\n          ) {\n            process.env.NODE_ENV !== \"production\" &&\n              this.log(\"Skip rule because user not included in rollout\", {\n                id,\n                rule,\n              });\n            continue;\n          }\n\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Force value from rule\", {\n              id,\n              rule,\n            });\n\n          // If this was a remotely evaluated experiment, fire the tracking callbacks\n          if (rule.tracks) {\n            rule.tracks.forEach((t) => {\n              this._track(t.experiment, t.result);\n            });\n          }\n\n          return this._getFeatureResult(id, rule.force as V, \"force\", rule.id);\n        }\n        if (!rule.variations) {\n          process.env.NODE_ENV !== \"production\" &&\n            this.log(\"Skip invalid rule\", {\n              id,\n              rule,\n            });\n\n          continue;\n        }\n        // For experiment rules, run an experiment\n        const exp: Experiment<V> = {\n          variations: rule.variations as [V, V, ...V[]],\n          key: rule.key || id,\n        };\n        if (\"coverage\" in rule) exp.coverage = rule.coverage;\n        if (rule.weights) exp.weights = rule.weights;\n        if (rule.hashAttribute) exp.hashAttribute = rule.hashAttribute;\n        if (rule.namespace) exp.namespace = rule.namespace;\n        if (rule.meta) exp.meta = rule.meta;\n        if (rule.ranges) exp.ranges = rule.ranges;\n        if (rule.name) exp.name = rule.name;\n        if (rule.phase) exp.phase = rule.phase;\n        if (rule.seed) exp.seed = rule.seed;\n        if (rule.hashVersion) exp.hashVersion = rule.hashVersion;\n        if (rule.filters) exp.filters = rule.filters;\n\n        // Only return a value if the user is part of the experiment\n        const res = this._run(exp, id);\n        this._fireSubscriptions(exp, res);\n        if (res.inExperiment && !res.passthrough) {\n          return this._getFeatureResult(\n            id,\n            res.value,\n            \"experiment\",\n            rule.id,\n            exp,\n            res\n          );\n        }\n      }\n    }\n\n    process.env.NODE_ENV !== \"production\" &&\n      this.log(\"Use default value\", {\n        id,\n        value: feature.defaultValue,\n      });\n\n    // Fall back to using the default value\n    return this._getFeatureResult(\n      id,\n      feature.defaultValue === undefined ? null : feature.defaultValue,\n      \"defaultValue\"\n    );\n  }\n\n  private _isIncludedInRollout(\n    seed: string,\n    hashAttribute: string | undefined,\n    range: VariationRange | undefined,\n    coverage: number | undefined,\n    hashVersion: number | undefined\n  ): boolean {\n    if (!range && coverage === undefined) return true;\n\n    const { hashValue } = this._getHashAttribute(hashAttribute);\n    if (!hashValue) {\n      return false;\n    }\n\n    const n = hash(seed, hashValue, hashVersion || 1);\n    if (n === null) return false;\n\n    return range\n      ? inRange(n, range)\n      : coverage !== undefined\n      ? n <= coverage\n      : true;\n  }\n\n  private _conditionPasses(condition: ConditionInterface): boolean {\n    return evalCondition(this.getAttributes(), condition);\n  }\n\n  private _isFilteredOut(filters: Filter[]): boolean {\n    return filters.some((filter) => {\n      const { hashValue } = this._getHashAttribute(filter.attribute);\n      if (!hashValue) return true;\n      const n = hash(filter.seed, hashValue, filter.hashVersion || 2);\n      if (n === null) return true;\n      return !filter.ranges.some((r) => inRange(n, r));\n    });\n  }\n\n  private _run<T>(\n    experiment: Experiment<T>,\n    featureId: string | null\n  ): Result<T> {\n    const key = experiment.key;\n    const numVariations = experiment.variations.length;\n\n    // 1. If experiment has less than 2 variations, return immediately\n    if (numVariations < 2) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Invalid experiment\", { id: key });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 2. If the context is disabled, return immediately\n    if (this._ctx.enabled === false) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Context disabled\", { id: key });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 2.5. Merge in experiment overrides from the context\n    experiment = this._mergeOverrides(experiment);\n\n    // 3. If a variation is forced from a querystring, return the forced variation\n    const qsOverride = getQueryStringOverride(\n      key,\n      this._getContextUrl(),\n      numVariations\n    );\n    if (qsOverride !== null) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Force via querystring\", {\n          id: key,\n          variation: qsOverride,\n        });\n      return this._getResult(experiment, qsOverride, false, featureId);\n    }\n\n    // 4. If a variation is forced in the context, return the forced variation\n    if (this._ctx.forcedVariations && key in this._ctx.forcedVariations) {\n      const variation = this._ctx.forcedVariations[key];\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Force via dev tools\", {\n          id: key,\n          variation,\n        });\n      return this._getResult(experiment, variation, false, featureId);\n    }\n\n    // 5. Exclude if a draft experiment or not active\n    if (experiment.status === \"draft\" || experiment.active === false) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because inactive\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 6. Get the hash attribute and return if empty\n    const { hashValue } = this._getHashAttribute(experiment.hashAttribute);\n    if (!hashValue) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because missing hashAttribute\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 7. Exclude if user is filtered out (used to be called \"namespace\")\n    if (experiment.filters) {\n      if (this._isFilteredOut(experiment.filters)) {\n        process.env.NODE_ENV !== \"production\" &&\n          this.log(\"Skip because of filters\", {\n            id: key,\n          });\n        return this._getResult(experiment, -1, false, featureId);\n      }\n    } else if (\n      experiment.namespace &&\n      !inNamespace(hashValue, experiment.namespace)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of namespace\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 7.5. Exclude if experiment.include returns false or throws\n    if (experiment.include && !isIncluded(experiment.include)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of include function\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 8. Exclude if condition is false\n    if (experiment.condition && !this._conditionPasses(experiment.condition)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of condition\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 8.1. Exclude if user is not in a required group\n    if (\n      experiment.groups &&\n      !this._hasGroupOverlap(experiment.groups as string[])\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of groups\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 8.2. Old style URL targeting\n    if (experiment.url && !this._urlIsValid(experiment.url as RegExp)) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of url\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 8.3. New, more powerful URL targeting\n    if (\n      experiment.urlPatterns &&\n      !isURLTargeted(this._getContextUrl(), experiment.urlPatterns)\n    ) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of url targeting\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 9. Get bucket ranges and choose variation\n    const n = hash(\n      experiment.seed || key,\n      hashValue,\n      experiment.hashVersion || 1\n    );\n    if (n === null) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of invalid hash version\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    const ranges =\n      experiment.ranges ||\n      getBucketRanges(\n        numVariations,\n        experiment.coverage === undefined ? 1 : experiment.coverage,\n        experiment.weights\n      );\n\n    const assigned = chooseVariation(n, ranges);\n\n    // 10. Return if not in experiment\n    if (assigned < 0) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because of coverage\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 11. Experiment has a forced variation\n    if (\"force\" in experiment) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Force variation\", {\n          id: key,\n          variation: experiment.force,\n        });\n      return this._getResult(\n        experiment,\n        experiment.force === undefined ? -1 : experiment.force,\n        false,\n        featureId\n      );\n    }\n\n    // 12. Exclude if in QA mode\n    if (this._ctx.qaMode) {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because QA mode\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 12.5. Exclude if experiment is stopped\n    if (experiment.status === \"stopped\") {\n      process.env.NODE_ENV !== \"production\" &&\n        this.log(\"Skip because stopped\", {\n          id: key,\n        });\n      return this._getResult(experiment, -1, false, featureId);\n    }\n\n    // 13. Build the result object\n    const result = this._getResult(experiment, assigned, true, featureId, n);\n\n    // 14. Fire the tracking callback\n    this._track(experiment, result);\n\n    // 15. Return the result\n    process.env.NODE_ENV !== \"production\" &&\n      this.log(\"In experiment\", {\n        id: key,\n        variation: result.variationId,\n      });\n    return result;\n  }\n\n  log(msg: string, ctx: Record<string, unknown>) {\n    if (!this.debug) return;\n    if (this._ctx.log) this._ctx.log(msg, ctx);\n    else console.log(msg, ctx);\n  }\n\n  private _track<T>(experiment: Experiment<T>, result: Result<T>) {\n    if (!this._ctx.trackingCallback) return;\n\n    const key = experiment.key;\n\n    // Make sure a tracking callback is only fired once per unique experiment\n    const k =\n      result.hashAttribute + result.hashValue + key + result.variationId;\n    if (this._trackedExperiments.has(k)) return;\n    this._trackedExperiments.add(k);\n\n    try {\n      this._ctx.trackingCallback(experiment, result);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  private _mergeOverrides<T>(experiment: Experiment<T>): Experiment<T> {\n    const key = experiment.key;\n    const o = this._ctx.overrides;\n    if (o && o[key]) {\n      experiment = Object.assign({}, experiment, o[key]);\n      if (typeof experiment.url === \"string\") {\n        experiment.url = getUrlRegExp(\n          // eslint-disable-next-line\n          experiment.url as any\n        );\n      }\n    }\n\n    return experiment;\n  }\n\n  private _getHashAttribute(attr?: string) {\n    const hashAttribute = attr || \"id\";\n\n    let hashValue = \"\";\n    if (this._attributeOverrides[hashAttribute]) {\n      hashValue = this._attributeOverrides[hashAttribute];\n    } else if (this._ctx.attributes) {\n      hashValue = this._ctx.attributes[hashAttribute] || \"\";\n    } else if (this._ctx.user) {\n      hashValue = this._ctx.user[hashAttribute] || \"\";\n    }\n\n    return { hashAttribute, hashValue };\n  }\n\n  private _getResult<T>(\n    experiment: Experiment<T>,\n    variationIndex: number,\n    hashUsed: boolean,\n    featureId: string | null,\n    bucket?: number\n  ): Result<T> {\n    let inExperiment = true;\n    // If assigned variation is not valid, use the baseline and mark the user as not in the experiment\n    if (variationIndex < 0 || variationIndex >= experiment.variations.length) {\n      variationIndex = 0;\n      inExperiment = false;\n    }\n\n    const { hashAttribute, hashValue } = this._getHashAttribute(\n      experiment.hashAttribute\n    );\n\n    const meta: Partial<VariationMeta> = experiment.meta\n      ? experiment.meta[variationIndex]\n      : {};\n\n    const res: Result<T> = {\n      key: meta.key || \"\" + variationIndex,\n      featureId,\n      inExperiment,\n      hashUsed,\n      variationId: variationIndex,\n      value: experiment.variations[variationIndex],\n      hashAttribute,\n      hashValue,\n    };\n\n    if (meta.name) res.name = meta.name;\n    if (bucket !== undefined) res.bucket = bucket;\n    if (meta.passthrough) res.passthrough = meta.passthrough;\n\n    return res;\n  }\n\n  private _getContextUrl() {\n    return this._ctx.url || (isBrowser ? window.location.href : \"\");\n  }\n\n  private _urlIsValid(urlRegex: RegExp): boolean {\n    const url = this._getContextUrl();\n    if (!url) return false;\n\n    const pathOnly = url.replace(/^https?:\\/\\//, \"\").replace(/^[^/]*\\//, \"/\");\n\n    if (urlRegex.test(url)) return true;\n    if (urlRegex.test(pathOnly)) return true;\n    return false;\n  }\n\n  private _hasGroupOverlap(expGroups: string[]): boolean {\n    const groups = this._ctx.groups || {};\n    for (let i = 0; i < expGroups.length; i++) {\n      if (groups[expGroups[i]]) return true;\n    }\n    return false;\n  }\n\n  private _applyDOMChanges(changes: AutoExperimentVariation) {\n    if (!isBrowser) return;\n    const undo: (() => void)[] = [];\n    if (changes.css) {\n      const s = document.createElement(\"style\");\n      s.innerHTML = changes.css;\n      document.head.appendChild(s);\n      undo.push(() => s.remove());\n    }\n    if (changes.js) {\n      const script = document.createElement(\"script\");\n      script.innerHTML = changes.js;\n      document.body.appendChild(script);\n      undo.push(() => script.remove());\n    }\n    if (changes.domMutations) {\n      changes.domMutations.forEach((mutation) => {\n        undo.push(mutate.declarative(mutation as DeclarativeMutation).revert);\n      });\n    }\n    return () => {\n      undo.forEach((fn) => fn());\n    };\n  }\n}\n"],"mappings":"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"}